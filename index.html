<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Calendar + Sheet (New GIS OAuth Only)</title>

  <!-- Some minimal styling for demo -->
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      font-family: sans-serif;
    }
    header, main {
      padding: 1rem;
    }
    #topHalf, #bottomHalf {
      padding: 1rem;
    }
    .split {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    ul { padding-left: 1.2rem; }
    button { margin-right: 1rem; }
  </style>
</head>
<body>
  <!-- Buttons for sign-in and sign-out -->
  <header>
    <button id="authorize_button" disabled>Authorize</button>
    <button id="signout_button" disabled>Sign Out</button>
  </header>

  <!-- Main content: top half (Calendar), bottom half (Sheets) -->
  <main class="split">
    <div id="topHalf">
      <h2>Calendar (Today + Next 6 Days)</h2>
      <ul id="calendar-events"></ul>
    </div>
    <div id="bottomHalf">
      <h2>Sheet Items (Single Column)</h2>
      <ul id="sheet-items"></ul>
    </div>
  </main>

  <!--
    1) Load the Google Identity Services library.
       onload="gisLoaded()" => calls our gisLoaded() function.
  -->
  <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>

  <!--
    2) Load the GAPI client library for calling Sheets/Calendar.
       onload="gapiLoaded()" => calls our gapiLoaded() function.
  -->
  <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>

  <script>
    /**********************************************************************
     * 1) CONFIGURATION
     **********************************************************************/
    // Your OAuth 2.0 Client ID from Google Cloud Console
    const CLIENT_ID = '138340694200-7b7bcj1ndlm3coovfs7hlf6alu8v0bou.apps.googleusercontent.com';

    // Scopes we need: read-only for Calendar and Sheets
    const SCOPES = [
      'https://www.googleapis.com/auth/calendar.readonly',
      'https://www.googleapis.com/auth/spreadsheets.readonly',
    ].join(' ');

    // IDs for your Calendar and Sheet
    const CALENDAR_ID = '2e45b1ad345b0c3420065de28fce836557d1eda41b2170b797e620ad7e228973@group.calendar.google.com';
    const SHEET_ID    = '1GjfSyjb4nGcFVNWez9Q55-Q9P2pnD30TenKeD0JQVeg';
    // The range in your Sheet you want (e.g. Sheet1!A:A)
    const SHEET_RANGE = 'Sheet1!A:A';

    /**********************************************************************
     * 2) GLOBALS
     **********************************************************************/
    let tokenClient;       // will hold the GIS token client
    let gapiInited   = false; // track if gapi client is fully loaded
    let gisInited    = false; // track if GIS library is fully loaded

    // Grab references to our buttons
    const authorizeButton = document.getElementById('authorize_button');
    const signoutButton   = document.getElementById('signout_button');

    /**********************************************************************
     * 3) INITIAL SETUP: LOADING GAPI + GIS LIBRARIES
     **********************************************************************/
    // Called once the "apis.google.com/js/api.js" script loads
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    // Initialize the GAPI client after loading
    async function initializeGapiClient() {
      // We do NOT supply apiKey because we rely entirely on OAuth tokens
      await gapi.client.init({
        // Discovery docs for the APIs we want
        discoveryDocs: [
          'https://sheets.googleapis.com/$discovery/rest?version=v4',
          'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
        ],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    // Called once the "accounts.google.com/gsi/client" script loads
    function gisLoaded() {
      // Initialize the token client
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // will set later
      });
      gisInited = true;
      maybeEnableButtons();
    }

    // Enable the "Authorize" button only when both libraries have inited
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        authorizeButton.disabled = false;
      }
    }

    /**********************************************************************
     * 4) AUTH / SIGN-IN FLOW (NEW GIS)
     **********************************************************************/
    authorizeButton.onclick = () => {
      // Request an access token (prompt user for consent if needed)
      tokenClient.callback = async (resp) => {
        if (resp.error) {
          console.error('OAuth token error:', resp);
          throw(resp);
        }
        // Now we have an access token!
        console.log('Access token acquired:', resp);

        // Set GAPI’s token so we can make requests
        gapi.client.setToken({ access_token: resp.access_token });

        // Hide the auth button, show the signout
        authorizeButton.style.display = 'none';
        signoutButton.style.display   = 'inline-block';

        // Now fetch the data
        await loadCalendarEvents();
        await loadSheetItems();
      };

      // Check if user already has a token
      if (!gapi.client.getToken()) {
        // No token, so request it (will show a consent screen or popup)
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        // Token exists; just use it
        tokenClient.callback({}); // call our own callback
      }
    };

    signoutButton.onclick = () => {
      // Clear GAPI’s token, hide data
      gapi.client.setToken(null);
      authorizeButton.style.display = 'inline-block';
      signoutButton.style.display   = 'none';

      document.getElementById('calendar-events').innerHTML = '';
      document.getElementById('sheet-items').innerHTML = '';
    };

    /**********************************************************************
     * 5) FETCH CALENDAR EVENTS
     **********************************************************************/
    async function loadCalendarEvents() {
      try {
        const now = new Date();
        const timeMin = now.toISOString();

        const future = new Date(now.getTime() + (6 * 24 * 60 * 60 * 1000));
        future.setHours(23, 59, 59, 999);
        const timeMax = future.toISOString();

        const resp = await gapi.client.calendar.events.list({
          calendarId: CALENDAR_ID,
          timeMin,
          timeMax,
          singleEvents: true,
          orderBy: 'startTime',
        });

        const events = resp.result.items || [];
        renderCalendarEvents(events);
      } catch (err) {
        console.error('Calendar API error:', err);
      }
    }

    function renderCalendarEvents(events) {
      const listEl = document.getElementById('calendar-events');
      listEl.innerHTML = '';

      if (!events.length) {
        listEl.innerHTML = '<li>No upcoming events.</li>';
        return;
      }
      for (let event of events) {
        const start = event.start.dateTime || event.start.date;
        const li = document.createElement('li');
        li.textContent = `${start} — ${event.summary}`;
        listEl.appendChild(li);
      }
    }

    /**********************************************************************
     * 6) FETCH SHEET ITEMS
     **********************************************************************/
    async function loadSheetItems() {
      try {
        const resp = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SHEET_ID,
          range: SHEET_RANGE,
        });
        const rows = resp.result.values || [];
        renderSheetItems(rows);
      } catch (err) {
        console.error('Sheets API error:', err);
      }
    }

    function renderSheetItems(rows) {
      const listEl = document.getElementById('sheet-items');
      listEl.innerHTML = '';

      if (!rows.length) {
        listEl.innerHTML = '<li>No items found.</li>';
        return;
      }
      for (const row of rows) {
        const val = row[0]; // single column
        if (val) {
          const li = document.createElement('li');
          li.textContent = val;
          listEl.appendChild(li);
        }
      }
    }
  </script>
</body>
</html>
