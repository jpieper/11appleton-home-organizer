<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Calendar + Sheet (GIS OAuth with Silent Re-Auth)</title>

  <!-- Minimal styling -->
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 1rem;
    }
    button {
      margin-right: 1rem;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }
    #topHalf, #bottomHalf {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    ul { padding-left: 1.2rem; }
  </style>
</head>
<body>
  <!-- Header with optional manual Auth buttons -->
  <header>
    <button id="authorizeButton" disabled>Authorize</button>
    <button id="signoutButton" disabled>Sign Out</button>
  </header>

  <main>
    <div id="topHalf">
      <h2>Calendar (Today + Next 6 Days)</h2>
      <ul id="calendar-events"></ul>
    </div>
    <div id="bottomHalf">
      <h2>Sheet Items (Single Column)</h2>
      <ul id="sheet-items"></ul>
    </div>
  </main>

  <!--
    1) Google Identity Services (GIS) library for OAuth
       We'll call gisLoaded() once it's loaded.
  -->
  <script
    src="https://accounts.google.com/gsi/client"
    async defer
    onload="gisLoaded()">
  </script>

  <!--
    2) Google API Client library (for Sheets/Calendar)
       We'll call gapiLoaded() once it's loaded.
  -->
  <script
    src="https://apis.google.com/js/api.js"
    async defer
    onload="gapiLoaded()">
  </script>

  <script>
    /***********************************************************************
     * 1) CONFIGURATION
     ***********************************************************************/
    // Provided by you:
    const CLIENT_ID   = '138340694200-7b7bcj1ndlm3coovfs7hlf6alu8v0bou.apps.googleusercontent.com';
    const CALENDAR_ID = '2e45b1ad345b0c3420065de28fce836557d1eda41b2170b797e620ad7e228973@group.calendar.google.com';
    const SHEET_ID    = '1GjfSyjb4nGcFVNWez9Q55-Q9P2pnD30TenKeD0JQVeg';

    // If your sheet data is in 'Sheet1' column A:
    const SHEET_RANGE = 'Sheet1!A:A';

    // OAuth scopes needed for reading Calendar and Sheets
    const SCOPES = [
      'https://www.googleapis.com/auth/calendar.readonly',
      'https://www.googleapis.com/auth/spreadsheets.readonly'
    ].join(' ');

    /***********************************************************************
     * 2) GLOBALS
     ***********************************************************************/
    let tokenClient;    // GIS token client
    let gapiInited = false;
    let gisInited  = false;

    // UI elements
    const authorizeButton = document.getElementById('authorizeButton');
    const signoutButton   = document.getElementById('signoutButton');

    /***********************************************************************
     * 3) LOADING THE GAPI & GIS LIBRARIES
     ***********************************************************************/
    // Called once the "apis.google.com/js/api.js" script loads
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    // After GAPI loads, initialize the client (no API key, just discovery docs)
    async function initializeGapiClient() {
      await gapi.client.init({
        discoveryDocs: [
          'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
          'https://sheets.googleapis.com/$discovery/rest?version=v4'
        ],
      });
      gapiInited = true;
      maybeEnableAuth();
    }

    // Called once the GIS script loads
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          // This callback is dynamically replaced before each token request
        },
      });
      gisInited = true;
      maybeEnableAuth();
    }

    // Enable the "Authorize" button if both libraries are ready
    function maybeEnableAuth() {
      if (gapiInited && gisInited) {
        authorizeButton.disabled = false;
        // Attempt silent re-auth on page load
        trySilentAuth();
      }
    }

    /***********************************************************************
     * 4) SILENT RE-AUTH & BUTTON HANDLERS
     ***********************************************************************/
    // Attempt a silent re-auth first
    function trySilentAuth() {
      console.log('Attempting silent re-auth...');
      tokenClient.callback = (resp) => {
        if (resp.error) {
          console.log('Silent re-auth failed:', resp.error);
          // Fallback: show or require user consent
          return;
        }
        console.log('Silent re-auth succeeded!');
        onAuthSuccess(resp.access_token);
      };

      // Attempt a token request with no prompt
      tokenClient.requestAccessToken();
    }

    // Called when user manually clicks "Authorize"
    authorizeButton.onclick = () => {
      doConsentAuth();
    };

    // Show a consent prompt to the user
    function doConsentAuth() {
      console.log('Consent-based auth...');
      tokenClient.callback = (resp) => {
        if (resp.error) {
          console.error('Consent auth failed:', resp.error);
          return;
        }
        console.log('Consent auth succeeded!');
        onAuthSuccess(resp.access_token);
      };

      tokenClient.requestAccessToken();
    }

    // When we sign out
    signoutButton.onclick = () => {
      gapi.client.setToken(null);
      authorizeButton.style.display = 'inline-block';
      signoutButton.style.display   = 'none';
      clearUI();
    };

    /***********************************************************************
     * 5) ON AUTH SUCCESS
     ***********************************************************************/
    function onAuthSuccess(accessToken) {
      // Set the token for GAPI
      gapi.client.setToken({ access_token: accessToken });

      // Update buttons
      authorizeButton.style.display = 'none';
      signoutButton.style.display   = 'inline-block';

      // Load both the calendar events and the sheet items
      loadCalendarEvents();
      loadSheetItems();
    }

    /***********************************************************************
     * 6) FETCH CALENDAR EVENTS
     ***********************************************************************/
    async function loadCalendarEvents() {
      try {
        const now     = new Date();
        const timeMin = now.toISOString();

        // Next 6 days from now
        const future  = new Date(now.getTime() + (6 * 24 * 60 * 60 * 1000));
        // set end-of-day
        future.setHours(23, 59, 59, 999);
        const timeMax = future.toISOString();

        const response = await gapi.client.calendar.events.list({
          calendarId: CALENDAR_ID,
          timeMin,
          timeMax,
          singleEvents: true,
          orderBy: 'startTime',
        });
        const events = response.result.items || [];
        renderCalendarEvents(events);
      } catch (err) {
        console.error('Calendar API error:', err);
      }
    }

    function renderCalendarEvents(events) {
      const ul = document.getElementById('calendar-events');
      ul.innerHTML = '';
      if (!events.length) {
        ul.innerHTML = '<li>No upcoming events found.</li>';
        return;
      }
      for (let event of events) {
        const start = event.start.dateTime || event.start.date;
        const li = document.createElement('li');
        li.textContent = `${start} â€” ${event.summary}`;
        ul.appendChild(li);
      }
    }

    /***********************************************************************
     * 7) FETCH SHEET ITEMS
     ***********************************************************************/
    async function loadSheetItems() {
      try {
        const resp = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SHEET_ID,
          range: SHEET_RANGE,
        });
        const rows = resp.result.values || [];
        renderSheetItems(rows);
      } catch (err) {
        console.error('Sheets API error:', err);
      }
    }

    function renderSheetItems(rows) {
      const ul = document.getElementById('sheet-items');
      ul.innerHTML = '';
      if (!rows.length) {
        ul.innerHTML = '<li>No items found.</li>';
        return;
      }
      rows.forEach(row => {
        const value = row[0]; // single column
        if (value) {
          const li = document.createElement('li');
          li.textContent = value;
          ul.appendChild(li);
        }
      });
    }

    // Clear the UI upon sign-out or if needed
    function clearUI() {
      document.getElementById('calendar-events').innerHTML = '';
      document.getElementById('sheet-items').innerHTML = '';
    }
  </script>
</body>
</html>
